# Stage 1: Build native image
FROM ghcr.io/graalvm/native-image-community:21 AS build

RUN microdnf install -y findutils && microdnf clean all

WORKDIR /app
COPY . .

RUN ./gradlew :agent:nativeCompile --no-daemon

# Stage 2: Minimal runtime
FROM debian:bookworm-slim

# Run as UID 996 to match the cluster node's 'aeron' user.
# Shared volumes (cluster data, /dev/shm) are owned by UID 996 â€”
# running as a different user would cause AccessDeniedException on mmap.
RUN groupadd -g 996 aeron && useradd -u 996 -g 996 aeron
COPY --from=build /app/agent/build/native/nativeCompile/agent /app/agent

USER 996
EXPOSE 7070
ENTRYPOINT ["/app/agent"]
