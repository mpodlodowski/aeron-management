name: 'aeron-cluster-big'

services:
  # === Aeron Cluster Nodes (5-node Raft consensus) ===
  node0:
    image: aeron-cluster-demo:local
    pull_policy: always
    environment:
      NODE_ID: 0
      CLUSTER_ADDRESSES: node0,node1,node2,node3,node4
      DEBUG: false
    restart: always
    volumes:
      - node-data-0:/home/aeron/aeron-cluster
      - shm-node0:/dev/shm
    networks:
      - net

  node1:
    image: aeron-cluster-demo:local
    pull_policy: always
    environment:
      NODE_ID: 1
      CLUSTER_ADDRESSES: node0,node1,node2,node3,node4
      DEBUG: false
    restart: always
    volumes:
      - node-data-1:/home/aeron/aeron-cluster
      - shm-node1:/dev/shm
    networks:
      - net

  node2:
    image: aeron-cluster-demo:local
    pull_policy: always
    environment:
      NODE_ID: 2
      CLUSTER_ADDRESSES: node0,node1,node2,node3,node4
      DEBUG: false
    restart: always
    volumes:
      - node-data-2:/home/aeron/aeron-cluster
      - shm-node2:/dev/shm
    networks:
      - net

  node3:
    image: aeron-cluster-demo:local
    pull_policy: always
    environment:
      NODE_ID: 3
      CLUSTER_ADDRESSES: node0,node1,node2,node3,node4
      DEBUG: false
    restart: always
    volumes:
      - node-data-3:/home/aeron/aeron-cluster
      - shm-node3:/dev/shm
    networks:
      - net

  node4:
    image: aeron-cluster-demo:local
    pull_policy: always
    environment:
      NODE_ID: 4
      CLUSTER_ADDRESSES: node0,node1,node2,node3,node4
      DEBUG: false
    restart: always
    volumes:
      - node-data-4:/home/aeron/aeron-cluster
      - shm-node4:/dev/shm
    networks:
      - net

  # === Aeron Backup ===
  backup:
    image: aeron-cluster-demo:local
    pull_policy: always
    environment:
      MODE: BACKUP
      CLUSTER_ADDRESSES: node0,node1,node2,node3,node4
      POD_IP: backup
      CLUSTER_BACKUP_INTERVAL_NS: 60000000000
      DEBUG: false
    restart: always
    volumes:
      - node-backup:/home/aeron/aeron-cluster
      - shm-backup:/dev/shm
    networks:
      - net

  # === Management Server (UI + gRPC aggregator) ===
  management-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      GRPC_SERVER_PORT: "8081"
    restart: always
    networks:
      - net

  # === Management Agents ===
  agent-0:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - node-data-0:/home/aeron/aeron-cluster
      - shm-node0:/dev/shm
    environment:
      MANAGEMENT_SERVER_HOST: management-server
      MANAGEMENT_SERVER_PORT: "8081"
      CLUSTER_DIR: /home/aeron/aeron-cluster/aeron-cluster-0/cluster
      AGENT_ID: agent-0
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - node-data-1:/home/aeron/aeron-cluster
      - shm-node1:/dev/shm
    environment:
      MANAGEMENT_SERVER_HOST: management-server
      MANAGEMENT_SERVER_PORT: "8081"
      CLUSTER_DIR: /home/aeron/aeron-cluster/aeron-cluster-1/cluster
      AGENT_ID: agent-1
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - node-data-2:/home/aeron/aeron-cluster
      - shm-node2:/dev/shm
    environment:
      MANAGEMENT_SERVER_HOST: management-server
      MANAGEMENT_SERVER_PORT: "8081"
      CLUSTER_DIR: /home/aeron/aeron-cluster/aeron-cluster-2/cluster
      AGENT_ID: agent-2
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-3:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - node-data-3:/home/aeron/aeron-cluster
      - shm-node3:/dev/shm
    environment:
      MANAGEMENT_SERVER_HOST: management-server
      MANAGEMENT_SERVER_PORT: "8081"
      CLUSTER_DIR: /home/aeron/aeron-cluster/aeron-cluster-3/cluster
      AGENT_ID: agent-3
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-4:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - node-data-4:/home/aeron/aeron-cluster
      - shm-node4:/dev/shm
    environment:
      MANAGEMENT_SERVER_HOST: management-server
      MANAGEMENT_SERVER_PORT: "8081"
      CLUSTER_DIR: /home/aeron/aeron-cluster/aeron-cluster-4/cluster
      AGENT_ID: agent-4
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-backup:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - node-backup:/home/aeron/aeron-cluster
      - shm-backup:/dev/shm
    environment:
      MANAGEMENT_SERVER_HOST: management-server
      MANAGEMENT_SERVER_PORT: "8081"
      CLUSTER_DIR: /home/aeron/aeron-cluster/cluster
      AGENT_ID: agent-backup
    depends_on:
      - management-server
    restart: always
    networks:
      - net

networks:
  net:

volumes:
  node-data-0:
  node-data-1:
  node-data-2:
  node-data-3:
  node-data-4:
  node-backup:
  shm-node0:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-node1:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-node2:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-node3:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-node4:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-backup:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
