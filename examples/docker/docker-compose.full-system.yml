name: 'aeron-cluster-managed'

services:
  # === Aeron Cluster Nodes (3-node Raft consensus) ===
  node0:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    build:
      context: ../k8s/cluster-image
    environment:
      NODE_ID: 0
      CLUSTER_ADDRESSES: node0,node1,node2
    restart: always
    volumes:
      - node-data-0:/home/aeron/aeron-cluster
      - shm-node0:/dev/shm
    networks:
      - net

  node1:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    build:
      context: ../k8s/cluster-image
    environment:
      NODE_ID: 1
      CLUSTER_ADDRESSES: node0,node1,node2
    restart: always
    volumes:
      - node-data-1:/home/aeron/aeron-cluster
      - shm-node1:/dev/shm
    networks:
      - net

  node2:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    build:
      context: ../k8s/cluster-image
    environment:
      NODE_ID: 2
      CLUSTER_ADDRESSES: node0,node1,node2
    restart: always
    volumes:
      - node-data-2:/home/aeron/aeron-cluster
      - shm-node2:/dev/shm
    networks:
      - net

  # === Aeron Backup Node ===
  backup:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    build:
      context: ../k8s/cluster-image
    hostname: backup
    command: ["BackupNode"]
    environment:
      CLUSTER_ADDRESSES: node0,node1,node2
    restart: always
    volumes:
      - node-backup:/home/aeron/aeron-cluster
      - shm-backup:/dev/shm
    networks:
      - net

  # === Management Server (UI + gRPC aggregator) ===
  management-server:
    image: ${SERVER_IMAGE:-aeron-management-server:local}
    build:
      context: ../..
      dockerfile: examples/docker/Dockerfile.server
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      AERON_MANAGEMENT_SERVER_GRPC_PORT: "8081"
    restart: always
    networks:
      - net

  # === Management Agents (sidecar per cluster node, shares /dev/shm for CnC access) ===
  # Agents auto-discover nodeId, aeronDir, and mode from the cluster-mark.dat file.
  # /dev/shm is shared via tmpfs volumes so agents can read CnC without IPC namespace coupling.
  agent-0:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    build:
      context: ../..
      dockerfile: examples/docker/Dockerfile.agent
    volumes:
      - node-data-0:/home/aeron/aeron-cluster
      - shm-node0:/dev/shm
    environment:
      AERON_MANAGEMENT_AGENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_AGENT_CLUSTER_DIR: /home/aeron/aeron-cluster
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-1:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    build:
      context: ../..
      dockerfile: examples/docker/Dockerfile.agent
    volumes:
      - node-data-1:/home/aeron/aeron-cluster
      - shm-node1:/dev/shm
    environment:
      AERON_MANAGEMENT_AGENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_AGENT_CLUSTER_DIR: /home/aeron/aeron-cluster
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-2:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    build:
      context: ../..
      dockerfile: examples/docker/Dockerfile.agent
    volumes:
      - node-data-2:/home/aeron/aeron-cluster
      - shm-node2:/dev/shm
    environment:
      AERON_MANAGEMENT_AGENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_AGENT_CLUSTER_DIR: /home/aeron/aeron-cluster
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-backup:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    build:
      context: ../..
      dockerfile: examples/docker/Dockerfile.agent
    volumes:
      - node-backup:/home/aeron/aeron-cluster
      - shm-backup:/dev/shm
    environment:
      AERON_MANAGEMENT_AGENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_AGENT_CLUSTER_DIR: /home/aeron/aeron-cluster
    depends_on:
      - management-server
    restart: always
    networks:
      - net

networks:
  net:

volumes:
  node-data-0:
  node-data-1:
  node-data-2:
  node-backup:
  # tmpfs volumes shared between nodes and agents for CnC file access
  shm-node0:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-node1:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-node2:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-backup:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
