name: 'aeron-multi-cluster'

services:
  # === Cluster "alpha" — 3 consensus nodes ===
  alpha-node0:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    build:
      context: ../k8s/cluster-image
    environment:
      NODE_ID: 0
      CLUSTER_ADDRESSES: alpha-node0,alpha-node1,alpha-node2
    restart: always
    volumes:
      - alpha-data-0:/home/aeron/aeron-cluster
      - shm-alpha0:/dev/shm
    networks:
      - net

  alpha-node1:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    environment:
      NODE_ID: 1
      CLUSTER_ADDRESSES: alpha-node0,alpha-node1,alpha-node2
    restart: always
    volumes:
      - alpha-data-1:/home/aeron/aeron-cluster
      - shm-alpha1:/dev/shm
    networks:
      - net

  alpha-node2:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    environment:
      NODE_ID: 2
      CLUSTER_ADDRESSES: alpha-node0,alpha-node1,alpha-node2
    restart: always
    volumes:
      - alpha-data-2:/home/aeron/aeron-cluster
      - shm-alpha2:/dev/shm
    networks:
      - net

  # === Cluster "alpha" — agents ===
  agent-alpha-0:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    build:
      context: ../..
      dockerfile: examples/docker/Dockerfile.agent
    volumes:
      - alpha-data-0:/home/aeron/aeron-cluster
      - shm-alpha0:/dev/shm
    environment:
      AERON_MANAGEMENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_CLUSTER_ID: alpha
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-alpha-1:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    volumes:
      - alpha-data-1:/home/aeron/aeron-cluster
      - shm-alpha1:/dev/shm
    environment:
      AERON_MANAGEMENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_CLUSTER_ID: alpha
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-alpha-2:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    volumes:
      - alpha-data-2:/home/aeron/aeron-cluster
      - shm-alpha2:/dev/shm
    environment:
      AERON_MANAGEMENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_CLUSTER_ID: alpha
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  # === Cluster "beta" — 3 consensus nodes ===
  beta-node0:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    environment:
      NODE_ID: 0
      CLUSTER_ADDRESSES: beta-node0,beta-node1,beta-node2
    restart: always
    volumes:
      - beta-data-0:/home/aeron/aeron-cluster
      - shm-beta0:/dev/shm
    networks:
      - net

  beta-node1:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    environment:
      NODE_ID: 1
      CLUSTER_ADDRESSES: beta-node0,beta-node1,beta-node2
    restart: always
    volumes:
      - beta-data-1:/home/aeron/aeron-cluster
      - shm-beta1:/dev/shm
    networks:
      - net

  beta-node2:
    image: ${CLUSTER_IMAGE:-aeron-cluster-demo:local}
    environment:
      NODE_ID: 2
      CLUSTER_ADDRESSES: beta-node0,beta-node1,beta-node2
    restart: always
    volumes:
      - beta-data-2:/home/aeron/aeron-cluster
      - shm-beta2:/dev/shm
    networks:
      - net

  # === Cluster "beta" — agents ===
  agent-beta-0:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    volumes:
      - beta-data-0:/home/aeron/aeron-cluster
      - shm-beta0:/dev/shm
    environment:
      AERON_MANAGEMENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_CLUSTER_ID: beta
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-beta-1:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    volumes:
      - beta-data-1:/home/aeron/aeron-cluster
      - shm-beta1:/dev/shm
    environment:
      AERON_MANAGEMENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_CLUSTER_ID: beta
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  agent-beta-2:
    image: ${AGENT_IMAGE:-aeron-management-agent:local}
    volumes:
      - beta-data-2:/home/aeron/aeron-cluster
      - shm-beta2:/dev/shm
    environment:
      AERON_MANAGEMENT_SERVER_HOST: management-server
      AERON_MANAGEMENT_CLUSTER_ID: beta
    depends_on:
      - management-server
    restart: always
    networks:
      - net

  # === Single Management Server (serves both clusters) ===
  management-server:
    image: ${SERVER_IMAGE:-aeron-management-server:local}
    build:
      context: ../..
      dockerfile: examples/docker/Dockerfile.server
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      AERON_MANAGEMENT_SERVER_PORT: "8081"
    restart: always
    networks:
      - net

networks:
  net:

volumes:
  # Cluster "alpha" data
  alpha-data-0:
  alpha-data-1:
  alpha-data-2:
  # Cluster "beta" data
  beta-data-0:
  beta-data-1:
  beta-data-2:
  # tmpfs volumes for /dev/shm (CnC file access)
  shm-alpha0:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-alpha1:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-alpha2:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-beta0:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-beta1:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  shm-beta2:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
